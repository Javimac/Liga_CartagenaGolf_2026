<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Club 2026 - Liga de Golf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        .modal-overlay { background-color: rgba(2, 6, 23, 0.95); backdrop-filter: blur(8px); }
        input[type="checkbox"] { accent-color: #16a34a; width: 1.25rem; height: 1.25rem; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ------------------------------------------------------------------
        // CONFIGURACIÓN FIREBASE
        // ------------------------------------------------------------------
        const manualConfig = {
            apiKey: "AIzaSyBqfSx5ulg2-X6BolLp7DACk6q4Y4-fEUw",
            authDomain: "liga-golf.firebaseapp.com",
            projectId: "liga-golf",
            storageBucket: "liga-golf.firebasestorage.app",
            messagingSenderId: "965701233208",
            appId: "1:965701233208:web:b8c54ce4071a30689614cd"
        };
        const currentAppId = "golf-tour-cartagena-2026-unified-v3"; // ID Nuevo para asegurar consistencia
        let db, auth;
        let useCloud = false;

        const initFirebase = () => {
            try {
                if (firebase.apps.length > 0) {
                    const existingApp = firebase.app();
                    if (existingApp.options.apiKey !== manualConfig.apiKey) {
                        firebase.app().delete().then(() => initFirebase());
                        return;
                    }
                } else {
                    firebase.initializeApp(manualConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                useCloud = true;
            } catch (e) {
                console.warn("Fallo crítico inicializando Firebase:", e);
                useCloud = false;
            }
        };
        initFirebase();

        const Icon = ({ name, className = "w-5 h-5" }) => {
            const [svg, setSvg] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    const iconData = window.lucide.icons[name];
                    const children = Array.isArray(iconData[2]) ? iconData[2] : (Array.isArray(iconData[1]) ? iconData[1] : []);
                    const paths = children.map(child => {
                        const [tag, attrs] = child;
                        const attrStr = Object.entries(attrs).map(([k,v]) => `${k}="${v}"`).join(' ');
                        return `<${tag} ${attrStr} />`;
                    }).join('');
                    setSvg(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${paths}</svg>`);
                }
            }, [name]);
            return svg ? <span className={`inline-flex items-center justify-center ${className}`} dangerouslySetInnerHTML={{ __html: svg }} /> : <span className={`inline-block w-5 h-5 bg-slate-800 rounded-full ${className}`}></span>;
        };

        const formatName = (raw) => {
            if (!raw) return "SOCIO";
            const clean = String(raw).replace(/"/g, '');
            if (!clean.includes(',')) return clean.toUpperCase();
            const [surnames, name] = clean.split(',').map(s => s.trim());
            const tc = (s) => s.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
            return `${tc(name)} ${tc(surnames)}`;
        };

        const App = () => {
            const [view, setView] = useState('ranking');
            const [players, setPlayers] = useState([]);
            const [lastAdjustments, setLastAdjustments] = useState([]);
            const [user, setUser] = useState(null);
            const [status, setStatus] = useState('loading');
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [showRules, setShowRules] = useState(false);
            const [password, setPassword] = useState('');
            const [selectedForRound, setSelectedForRound] = useState([]);
            const [roundResults, setRoundResults] = useState({}); 
            const [roundStats, setRoundStats] = useState({});
            const [includedInSync, setIncludedInSync] = useState({}); 
            const [sortConfig, setSortConfig] = useState({ key: 'totalPoints', direction: 'desc' });

            const ADMIN_PASS = "1234";
            const MAX_COUNTED = 50;

            useEffect(() => {
                const load = async () => {
                    const loadLocal = () => {
                        try {
                            const p = JSON.parse(localStorage.getItem('golf_players') || '[]');
                            const a = JSON.parse(localStorage.getItem('golf_adjustments') || '[]');
                            setPlayers(p);
                            setLastAdjustments(a);
                        } catch(e) {}
                        setStatus('ready');
                    };

                    if (useCloud && auth) {
                        try {
                            await auth.signInAnonymously();
                            const ref = db.collection('artifacts').doc(currentAppId).collection('public').doc('data');
                            ref.collection('players').onSnapshot(snap => {
                                const list = snap.docs.map(d => ({id: d.id, ...d.data()}));
                                setPlayers(list);
                                localStorage.setItem('golf_players', JSON.stringify(list));
                                setStatus('ready');
                            }, err => { loadLocal(); });

                            ref.collection('global_stats').doc('adjustments').onSnapshot(d => {
                                if(d.exists) setLastAdjustments(d.data().history || []);
                            });
                        } catch (e) { loadLocal(); }
                    } else { loadLocal(); }
                };
                load();
            }, []);

            const saveDataLocal = (newPlayers, newAdjustments) => {
                localStorage.setItem('golf_players', JSON.stringify(newPlayers));
                if (newAdjustments) localStorage.setItem('golf_adjustments', JSON.stringify(newAdjustments));
                setPlayers(newPlayers);
                if (newAdjustments) setLastAdjustments(newAdjustments);
            };

            const resetSeason = async () => {
                if (!confirm("⚠ ¿BORRAR TODOS LOS DATOS?")) return;
                if (prompt("Escribe 'BORRAR':") !== 'BORRAR') return;
                setStatus('loading');
                try {
                    localStorage.removeItem('golf_players');
                    localStorage.removeItem('golf_adjustments');
                    if (useCloud && db) {
                        const batch = db.batch();
                        const pubRef = db.collection('artifacts').doc(currentAppId).collection('public').doc('data');
                        batch.delete(pubRef.collection('global_stats').doc('adjustments'));
                        const snap = await pubRef.collection('players').get();
                        snap.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }
                    setPlayers([]);
                    setLastAdjustments([]);
                    window.location.reload();
                } catch(e) { setStatus('ready'); alert("Error al borrar"); }
            };

            const handleFiles = (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                const allRows = [];
                let processed = 0;

                const readFile = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const data = new Uint8Array(ev.target.result);
                            const wb = XLSX.read(data, {type:'array'});
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            // Leemos con cabecera en fila 1 para procesar más fácil
                            const json = XLSX.utils.sheet_to_json(ws, {header:1});
                            resolve(json);
                        };
                        reader.readAsArrayBuffer(file);
                    });
                };

                files.forEach(async (file) => {
                    try {
                        const rows = await readFile(file);
                        // Buscar dinámicamente dónde empieza la tabla
                        let startIdx = -1;
                        let headerRow = [];
                        
                        for (let i=0; i<Math.min(rows.length, 25); i++) {
                            const rowStr = (rows[i]||[]).map(c => String(c).toLowerCase()).join(' ');
                            if (rowStr.includes('licencia') && rowStr.includes('nombre')) { 
                                startIdx = i; 
                                headerRow = rows[i].map(c => String(c).toLowerCase().trim());
                                break; 
                            }
                        }

                        if (startIdx !== -1) {
                            // Mapear índices de columnas
                            const idxLic = headerRow.indexOf('licencia');
                            const idxName = headerRow.indexOf('nombre');
                            const idxHcp = headerRow.findIndex(c => c.includes('hce') || c.includes('hcpe'));
                            const idxRes = headerRow.findIndex(c => c.includes('total') || c.includes('neto'));
                            
                            // Añadimos datos normalizados
                            rows.slice(startIdx + 1).forEach(row => { 
                                if (row.length > 3) {
                                    allRows.push({
                                        rawName: row[idxName],
                                        license: row[idxLic],
                                        hcpStr: row[idxHcp],
                                        resStr: row[idxRes],
                                        fullRow: row // Guardamos para birdies
                                    });
                                }
                            });
                        }
                    } catch (err) { console.error(err); }
                    processed++;
                    if (processed === files.length && allRows.length > 0) processAllRows(allRows);
                });
            };

            const processAllRows = (dataList) => {
                let extracted = dataList.map(item => {
                    if (!item.license && !item.rawName) return null;
                    
                    const lic = String(item.license || "").trim();
                    const rawName = String(item.rawName || "").trim();
                    
                    // HCP
                    let hcp = 18;
                    if (item.hcpStr) hcp = typeof item.hcpStr === 'number' ? item.hcpStr : parseFloat(String(item.hcpStr).replace(',','.'));
                    
                    // Res Total
                    let resTotal = 999;
                    if (item.resStr) {
                        const s = String(item.resStr).toUpperCase();
                        if (s === 'PAR' || s === 'E') resTotal = 0;
                        else resTotal = parseInt(s) || 999;
                    }

                    // Birdies (Indices fijos de hoyos aprox 11-28 en Resultados)
                    let b=0, eg=0;
                    if (item.fullRow.length > 20) {
                        // Buscamos patrones de -1 y -2 en toda la fila por seguridad
                        item.fullRow.forEach(cell => {
                            if (cell === -1) b++;
                            if (cell === -2) eg++;
                        });
                    }

                    return { 
                        name: formatName(rawName), 
                        license: lic, 
                        handicap: hcp, 
                        score: resTotal, 
                        birdies: b, eagles: eg, underPar: resTotal < 0 
                    };
                }).filter(x => x!==null);

                // FUSIONAR DUPLICADOS (Si sale en 2 archivos, sumamos birdies del mejor)
                const mergedMap = new Map();
                extracted.forEach(p => {
                    const key = p.license || p.name;
                    if (!mergedMap.has(key)) {
                        mergedMap.set(key, p);
                    } else {
                        const existing = mergedMap.get(key);
                        // Quedarse con el que tenga más birdies (significa que vino del archivo Resultados)
                        if (p.birdies > existing.birdies) mergedMap.set(key, p);
                    }
                });
                
                const finalPlayers = Array.from(mergedMap.values());

                // ORDENAR POR RESULTADO (UNIFICADO)
                finalPlayers.sort((a,b) => {
                    if (a.score !== b.score) return a.score - b.score;
                    return a.handicap - b.handicap;
                });

                const res = {}, st = {}, sel = [], inc = {};
                
                finalPlayers.forEach((data, idx) => {
                    let player = players.find(p => p.license === data.license || p.name === data.name);
                    const pid = player ? player.id : `new_${data.license || Math.random()}`;
                    
                    if (!sel.includes(pid)) {
                        sel.push(pid);
                        res[pid] = idx + 1; // POSICIÓN RECALCULADA
                        inc[pid] = true;
                        st[pid] = { ...data, isNew: !player };
                    }
                });
                
                setSelectedForRound(sel); setRoundResults(res); setRoundStats(st); setIncludedInSync(inc); setView('add');
            };

            const confirmRound = async () => {
                const toSync = selectedForRound.filter(id => includedInSync[id]);
                if(!toSync.length) return alert("Selecciona jugadores");
                
                // Reordenar por la posición calculada
                toSync.sort((a,b) => roundResults[a] - roundResults[b]);
                
                const num = toSync.length;
                const table = num>=11?[50,42,35,30,26,22,19,16,14,12,10,9,8]:num>=7?[35,29,24,20,17,14,12,10,8,7]:[20,16,12,9,7,5];
                
                let updatedPlayers = [...players];
                const adjs = [];
                const pubRef = db ? db.collection('artifacts').doc(currentAppId).collection('public').doc('data') : null;

                for (let i = 0; i < toSync.length; i++) {
                    const tid = toSync[i];
                    const s = roundStats[tid];
                    const realRank = i + 1; 

                    let player = players.find(p => p.license === s.license);
                    let ref, data;

                    if (!player) {
                         const newP = { name: s.name, license: s.license, handicap: s.handicap, scores: [], birdies: 0, eagles: 0, bonusUnderPar: 0, games: 0 };
                        if (useCloud) {
                            const doc = await pubRef.collection('players').add(newP);
                            ref = doc; data = { ...newP, id: doc.id };
                        } else {
                            newP.id = `loc_${Date.now()}_${i}`; data = newP; updatedPlayers.push(data);
                        }
                    } else {
                        ref = useCloud ? pubRef.collection('players').doc(player.id) : null;
                        data = player;
                    }

                    const pts = table[realRank-1] || 2;
                    let adj = 0;
                    if(realRank===1) adj = -0.4;
                    else if(realRank===2) adj = -0.2;
                    else if(realRank===3) adj = -0.1;
                    if(s.underPar) adj -= 0.2;
                    if(num>5 && realRank>num-2) adj += 0.1;
                    
                    const newHcp = Math.max(0, parseFloat((data.handicap + adj).toFixed(1)));
                    if (adj !== 0) adjs.push({ name: s.name, change: adj, final: newHcp });
                    
                    const newScores = [...(data.scores||[]), Number(pts)];
                    
                    const pIndex = updatedPlayers.findIndex(p => p.id === data.id);
                    if(pIndex !== -1) {
                         updatedPlayers[pIndex] = {
                            ...data,
                            handicap: newHcp,
                            scores: newScores,
                            birdies: (data.birdies||0) + s.birdies,
                            eagles: (data.eagles||0) + s.eagles,
                            bonusUnderPar: (data.bonusUnderPar||0) + (s.underPar?5:0),
                            games: (data.games||0) + 1
                         };
                    }

                    if (useCloud && ref) {
                        await ref.update({
                            handicap: newHcp,
                            scores: newScores,
                            birdies: firebase.firestore.FieldValue.increment(s.birdies),
                            eagles: firebase.firestore.FieldValue.increment(s.eagles),
                            bonusUnderPar: firebase.firestore.FieldValue.increment(s.underPar?5:0),
                            games: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                }
                
                if (useCloud) { pubRef.collection('global_stats').doc('adjustments').set({history: adjs}); } 
                else { saveDataLocal(updatedPlayers, adjs); }
                setSelectedForRound([]); setView('ranking');
            };

            const rankingData = useMemo(() => {
                const data = players.map(p => {
                    const sorted = [...(p.scores || [])].sort((a,b) => b-a);
                    const best = sorted.slice(0, MAX_COUNTED);
                    const pts = best.reduce((a,b) => Number(a)+Number(b), 0);
                    const bonus = (Number(p.birdies)||0) + (Number(p.eagles)||0)*2 + (Number(p.games)||0)*2 + (Number(p.bonusUnderPar)||0);
                    return { ...p, totalPoints: pts + bonus, posTotal: pts, bonusAccum: bonus, avg: p.games > 0 ? (pts / Math.min(p.games, MAX_COUNTED)).toFixed(1) : "0" };
                });
                return data.sort((a, b) => {
                    if (sortConfig.key === 'totalPoints') return sortConfig.direction === 'desc' ? b.totalPoints - a.totalPoints : a.totalPoints - b.totalPoints;
                    if (sortConfig.key === 'name') return sortConfig.direction === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                    if (sortConfig.key === 'handicap') return sortConfig.direction === 'asc' ? a.handicap - b.handicap : b.handicap - a.handicap;
                });
            }, [players, sortConfig]);

            const handleSort = (key) => setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc' }));
            const handleLogin = (e) => { e.preventDefault(); if(password===ADMIN_PASS){setIsAdmin(true);setShowLogin(false);setPassword('')}else{alert("Clave incorrecta")} };
            const uncheckNewMembers = () => { const n = {...includedInSync}; selectedForRound.forEach(id => { if(roundStats[id].isNew) n[id] = false; }); setIncludedInSync(n); };
            const addManualPlayer = async () => {
                const n = prompt("Nombre:"); const h = prompt("HCP:");
                if(n&&h) {
                    const newP = { id: `man_${Date.now()}`, name: n.toUpperCase(), license: '', handicap: parseFloat(h.replace(',','.')), scores: [], birdies: 0, eagles: 0, bonusUnderPar: 0, games: 0 };
                    if(useCloud) await db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('players').add(newP);
                    else saveDataLocal([...players, newP], lastAdjustments);
                }
            };
            const deletePlayer = async (id) => { if(confirm("¿Borrar?")) { if(useCloud) await db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('players').doc(id).delete(); else saveDataLocal(players.filter(p=>p.id!==id), lastAdjustments); } };

            if (status === 'loading') return <div className="h-screen bg-slate-950 flex items-center justify-center"><div className="w-10 h-10 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div></div>;

            // --- RENDER VISUAL ---
            // Creamos una copia segura para ordenar en el render
            const playersToRender = [...selectedForRound].filter(id => roundResults[id] !== undefined);
            playersToRender.sort((a,b) => roundResults[a] - roundResults[b]);

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 flex flex-col max-w-5xl mx-auto">
                    <header className="p-4 border-b border-white/10 flex justify-between items-center sticky top-0 bg-slate-950/80 backdrop-blur z-50">
                        <div className="flex items-center gap-3">
                            <div className="bg-green-600 p-2 rounded-lg shadow-lg rotate-[-3deg]"><Icon name="Trophy" className="text-white" /></div>
                            <h1 className="text-xl font-black italic tracking-tighter">TOUR 2026</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setShowRules(true)} className="bg-blue-600/20 text-blue-400 border border-blue-600/50 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase flex items-center gap-1 hover:bg-blue-600/30 transition-all shadow-lg"><Icon name="BookOpen" className="w-3 h-3" /> Bases</button>
                            {!isAdmin ? (!showLogin ? (
                                <button onClick={()=>setShowLogin(true)} className="text-[10px] font-black uppercase text-green-500 border border-green-500/30 px-3 py-1.5 rounded-lg">Capitán</button>
                            ) : (
                                <form onSubmit={handleLogin} className="flex gap-2"><input autoFocus type="password" placeholder="Clave" className="bg-slate-800 rounded px-2 text-xs w-20" value={password} onChange={e=>setPassword(e.target.value)}/><button className="text-green-500"><Icon name="CheckCircle2" /></button></form>
                            )) : <button onClick={()=>setIsAdmin(false)} className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold">Salir</button>}
                        </div>
                    </header>

                    {showRules && (
                        <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-6 animate-in">
                            <div className="bg-slate-900 border border-white/10 rounded-3xl w-full max-w-lg p-6 relative shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar">
                                <button onClick={()=>setShowRules(false)} className="absolute top-4 right-4 bg-white/10 p-2 rounded-full hover:bg-white/20"><Icon name="X" className="w-5 h-5 text-white" /></button>
                                <div className="text-center mb-6"><h2 className="text-2xl font-black uppercase italic text-blue-500 tracking-tighter">Bases del Tour 2026</h2><p className="text-xs text-slate-500 font-bold uppercase tracking-widest">Reglamento Oficial</p></div>
                                <div className="space-y-6 text-sm">
                                    <div className="p-4 bg-slate-800/50 rounded-2xl border border-white/5"><h3 className="font-bold text-white mb-2 flex items-center gap-2"><Icon name="Target" className="w-4 h-4 text-green-500" /> Puntos por Jornada</h3><div className="grid grid-cols-3 gap-2 text-center text-xs"><div className="bg-slate-950 p-2 rounded-lg border border-white/10"><p className="text-slate-500 mb-1">MAJOR (+11)</p><p className="font-black text-green-400 text-lg">50 pts</p></div><div className="bg-slate-950 p-2 rounded-lg border border-white/10"><p className="text-slate-500 mb-1">TOUR (7-10)</p><p className="font-black text-blue-400 text-lg">35 pts</p></div><div className="bg-slate-950 p-2 rounded-lg border border-white/10"><p className="text-slate-500 mb-1">SOCIAL (3-6)</p><p className="font-black text-orange-400 text-lg">20 pts</p></div></div></div>
                                    <div className="p-4 bg-slate-800/50 rounded-2xl border border-white/5"><h3 className="font-bold text-white mb-2 flex items-center gap-2"><Icon name="Zap" className="w-4 h-4 text-orange-500" /> Bonus</h3><ul className="space-y-2 text-xs font-medium text-slate-300"><li className="flex justify-between border-b border-white/5 pb-1"><span>Birdie</span> <span className="text-green-400 font-bold">+1 pto</span></li><li className="flex justify-between border-b border-white/5 pb-1"><span>Eagle</span> <span className="text-orange-400 font-bold">+2 ptos</span></li><li className="flex justify-between border-b border-white/5 pb-1"><span>Under Par</span> <span className="text-blue-400 font-bold">+5 ptos</span></li><li className="flex justify-between"><span>Asistencia</span> <span className="text-slate-400 font-bold">+2 ptos</span></li></ul></div>
                                    <div className="p-4 bg-slate-800/50 rounded-2xl border border-white/5"><h3 className="font-bold text-white mb-2 flex items-center gap-2"><Icon name="RefreshCw" className="w-4 h-4 text-purple-500" /> Hándicap Dinámico</h3><p className="text-xs text-slate-400 leading-relaxed">Ganador <strong>-0.4</strong>, 2º <strong>-0.2</strong>, 3º <strong>-0.1</strong>. Under Par <strong>-0.2 extra</strong>. Últimos <strong>+0.1</strong>.</p></div>
                                </div>
                                <button onClick={()=>setShowRules(false)} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl mt-6 uppercase text-xs tracking-widest shadow-lg transition-all">Cerrar</button>
                            </div>
                        </div>
                    )}

                    <main className="p-4 flex-1">
                        {isAdmin && (
                            <div className="flex bg-white/5 p-1 rounded-xl mb-6 gap-1 overflow-x-auto">
                                <button onClick={()=>setView('ranking')} className={`flex-1 py-2 px-4 rounded-lg text-xs font-bold ${view==='ranking'?'bg-white text-black':'text-slate-400'}`}>Ranking</button>
                                <button onClick={()=>setView('import')} className={`flex-1 py-2 px-4 rounded-lg text-xs font-bold ${view==='import'?'bg-blue-600 text-white':'text-slate-400'}`}>Importar</button>
                                <button onClick={()=>setView('roster')} className={`flex-1 py-2 px-4 rounded-lg text-xs font-bold ${view==='roster'?'bg-purple-600 text-white':'text-slate-400'}`}>Socios</button>
                            </div>
                        )}

                        {view === 'ranking' && (
                            <div className="space-y-6">
                                {lastAdjustments.length > 0 && (
                                    <div className="bg-blue-900/20 p-4 rounded-2xl border border-blue-500/20 flex flex-wrap gap-2">
                                        <div className="w-full text-[10px] uppercase font-bold text-blue-400 mb-1">Últimos Cambios HCP</div>
                                        {lastAdjustments.map((a,i) => <span key={i} className="bg-slate-800 px-2 py-1 rounded text-xs"><b>{a.name}</b> {a.change>0?'+':''}{a.change}</span>)}
                                    </div>
                                )}
                                
                                {rankingData.length === 0 ? <div className="text-center p-10 text-slate-500 text-xs font-bold uppercase">Sin datos</div> : (
                                    <div className="bg-slate-900 rounded-2xl border border-white/5 overflow-hidden">
                                        <div className="flex bg-white/5 p-2 border-b border-white/5 text-[10px] font-bold text-slate-500 uppercase">
                                            <button onClick={()=>handleSort('totalPoints')} className="flex-1 text-left p-2">Pos</button>
                                            <button onClick={()=>handleSort('name')} className="flex-[3] text-left p-2">Socio</button>
                                            <button onClick={()=>handleSort('handicap')} className="flex-1 text-center p-2">HCP</button>
                                            <button onClick={()=>handleSort('totalPoints')} className="flex-1 text-right p-2">Pts</button>
                                        </div>
                                        <div className="divide-y divide-white/5">
                                            {rankingData.map((p,i) => (
                                                <div key={p.id} className="flex text-sm hover:bg-white/5 transition-colors">
                                                    <div className="flex-1 p-4 font-bold text-slate-500">{i+1}</div>
                                                    <div className="flex-[3] p-4 font-bold text-white truncate">{p.name} <div className="text-[10px] font-normal text-slate-500">{p.games} Partidas</div></div>
                                                    <div className="flex-1 p-4 text-center font-mono text-green-400">{p.handicap}</div>
                                                    <div className="flex-1 p-4 text-right font-black text-lg text-white">
                                                        {p.totalPoints}
                                                        <div className="text-[9px] text-slate-500 font-normal">
                                                            Pos:{p.posTotal} + B:{p.bonusAccum}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'import' && (
                            <div className="text-center py-10 bg-slate-900/50 rounded-3xl border border-dashed border-white/10">
                                <Icon name="Upload" className="w-12 h-12 mx-auto text-blue-500 mb-4" />
                                <h2 className="text-xl font-black italic mb-6">Subir Resultados</h2>
                                <label className="bg-blue-600 px-6 py-3 rounded-xl font-bold text-xs uppercase cursor-pointer hover:bg-blue-500">
                                    Seleccionar CSV / Excel
                                    <input type="file" multiple className="hidden" accept=".csv, .xlsx" onChange={handleFiles} />
                                </label>
                                <p className="text-[10px] text-slate-500 mt-4 font-bold uppercase tracking-widest">Soporta Múltiples Archivos</p>
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-bold text-green-500">Validar ({Object.values(includedInSync).filter(v=>v).length})</h2>
                                    <button onClick={uncheckNewMembers} className="text-[10px] uppercase border border-orange-500/50 text-orange-500 px-3 py-1 rounded">Ignorar Invitados</button>
                                </div>
                                {playersToRender.map(id => {
                                    const s = roundStats[id]; const inc = includedInSync[id];
                                    
                                    // Cálculo provisional para mostrar en pantalla
                                    const activePlayers = playersToRender.filter(rid => includedInSync[rid]);
                                    const realRankIndex = activePlayers.indexOf(id); 
                                    const realRank = realRankIndex + 1;
                                    const numPlayers = activePlayers.length;
                                    const pointsTable = numPlayers>=11?[50,42,35,30,26,22,19,16,14,12,10,9,8]:numPlayers>=7?[35,29,24,20,17,14,12,10,8,7]:[20,16,12,9,7,5];
                                    const posPoints = inc ? (pointsTable[realRank-1] || 2) : 0;
                                    const bonus = (s.birdies*1) + (s.eagles*2) + (s.underPar?5:0) + 2; 

                                    return (
                                        <div key={id} className={`p-3 rounded-xl border flex justify-between items-center ${inc?'bg-white/5 border-white/10':'opacity-30 border-transparent'}`}>
                                            <div className="flex items-center gap-3">
                                                <input type="checkbox" checked={inc} onChange={()=>setIncludedInSync({...includedInSync, [id]:!inc})} />
                                                <div>
                                                    <div className="font-bold text-sm">{s.name}</div>
                                                    <div className="text-[10px] text-slate-500">
                                                        POS: {realRank}º <span className="text-green-500 font-bold">(+{posPoints} pts)</span> + <span className="text-orange-400">Bonus: +{bonus}</span>
                                                        {s.isNew && inc ? ' • NUEVO' : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                                <button onClick={confirmRound} className="w-full bg-green-600 py-4 rounded-xl font-black uppercase text-sm mt-4 shadow-lg">Sincronizar</button>
                            </div>
                        )}

                        {view === 'roster' && (
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <button onClick={addManualPlayer} className="flex-1 bg-purple-600 py-3 rounded-xl text-xs font-bold uppercase flex items-center justify-center gap-2"><Icon name="PlusCircle" className="w-4 h-4" /> Nuevo</button>
                                    <button onClick={resetSeason} className="flex-1 bg-red-600/20 text-red-500 border border-red-600/50 py-3 rounded-xl text-xs font-bold uppercase flex items-center justify-center gap-2"><Icon name="Trash2" className="w-4 h-4" /> Reiniciar Liga</button>
                                </div>
                                <div className="grid gap-2">
                                    {players.map(p => (
                                        <div key={p.id} className="bg-slate-900 p-4 rounded-xl flex justify-between items-center border border-white/5">
                                            <div><div className="font-bold text-sm">{p.name}</div><div className="text-[10px] text-slate-500">HCP: {p.handicap}</div></div>
                                            <button onClick={()=>deletePlayer(p.id)} className="text-red-500"><Icon name="Trash2" className="w-4 h-4" /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Footer Info */}
                    <div className="fixed bottom-6 left-6 right-6 max-w-lg mx-auto pointer-events-none z-50">
                        <div className="bg-slate-900/95 backdrop-blur-2xl border border-white/10 p-5 rounded-2xl shadow-2xl flex justify-between items-center px-10 border-green-500/10">
                            <div className="flex items-center gap-4">
                                <div className="bg-green-600/20 p-2 rounded-xl text-green-500 shadow-inner"><Icon name="ShieldCheck" className="w-5 h-5" /></div>
                                <p className="text-[10px] font-black text-white uppercase italic tracking-tighter">
                                    {useCloud ? 'Conexión Cloud Activa' : 'Modo Local (Sin Sync)'}
                                </p>
                            </div>
                            <div className={`bg-${useCloud ? 'green' : 'orange'}-500/20 px-3 py-1 rounded-full`}>
                                <div className={`w-1.5 h-1.5 bg-${useCloud ? 'green' : 'orange'}-500 rounded-full animate-pulse`}></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>